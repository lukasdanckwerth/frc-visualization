<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no"
    />
    <link rel="stylesheet" href="./css/lotivis.css" />
    <link rel="stylesheet" href="./css/frcv.css" />
    <title>FRCV - Corpus Overview</title>
  </head>

  <body>
    <div class="frcv-container">
      <!-- HEADER -->
      <div class="frcv-col-3">
        <a href="index.html" class="btn">Back</a>
      </div>
      <div class="frcv-col-3 frcv-center">
        <span>Corpus Overview</span>
      </div>
      <div class="frcv-col-3 frcv-end">
        <select id="data" onchange="dataChange()">
          <option>Tracks</option>
          <option>Words</option>
          <option>Types</option>
          <option>Innovation List</option>
          <option>Innovation List (Rel. Date)</option>
          <option>Innovation List (Rel. Location)</option>
          <option>Innovation List (Words)</option>
          <option>Innovation List (Words) (Rel. Date)</option>
          <option>Innovation List (Words) (Rel. Location)</option>
        </select>
      </div>
      <br />
      <br />
      <div class="frcv-col-2">
        <div class="frcv-headline">
          <span>Bar</span>
          <button type="button" onclick="screenshot('bar-chart')">
            Screenshot
          </button>
        </div>
        <div id="bar-chart">
          <!-- Bar Chart Here -->
        </div>

        <div class="frcv-headline">
          <span>Plot</span>
          <button type="button" onclick="screenshot('plot-chart')">
            Screenshot
          </button>
        </div>
        <div id="plot-chart">
          <!-- Plot Chart Here -->
        </div>
      </div>

      <div class="frcv-col-2">
        <div class="frcv-headline">
          <span>Map</span>
          <button type="button" onclick="screenshot('map-chart')">
            Screenshot
          </button>
        </div>
        <div id="map-chart">
          <!-- Map Chart Here -->
        </div>

        <div class="row frcv-headline">
          <span>Info</span>
        </div>
        <div class="frcv-info">
          <div>All: <span id="frcv-artists-all"></span></div>
          <div>Female: <span id="frcv-artists-female"></span></div>
          <div>Male: <span id="frcv-artists-male"></span></div>
          <div>Groups: <span id="frcv-artists-groups"></span></div>
          <div>Tracks: <span id="frcv-tracks"></span></div>
          <div>Words: <span id="frcv-words"></span></div>
          <div>Types: <span id="frcv-types"></span></div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.0/html2canvas.min.js"></script>
    <script src="js/lib/lotivis.js"></script>
    <script src="js/lib/frc.js"></script>

    <script>
      // enable debug mode
      lotivis.debug(true);
      lotivis.config.downloadFilePrefix = "frcv";

      let d3 = lotivis.d3;
      let corpus = null;
      let datasets = [];

      // create lotivis elements
      let barChart = new lotivis.BarChart("bar-chart", {
        labels: true,
        selectable: false,
        dates: d3.range(1995, 2021),
      });

      let mapChart = new lotivis.MapChart("map-chart", {
        labels: true,
        excludedFeatureCodes: ["2A", "2B"],
        featureIDAccessor: (f) => "" + f.properties.code,
        featureNameAccessor: (f) => f.properties.nom,
      });

      let plotChart = new lotivis.PlotChart("plot-chart", {
        type: "fraction",
        selectable: false,
        dates: d3.range(1995, 2021),
      });

      function screenshot(id) {
        html2canvas(document.getElementById(id), {
          scale: 4,
        }).then((canvas) => {
          // convert canvas to base64
          let base64Data = canvas
            .toDataURL()
            .replace("data:image/png;base64,", "");

          // receive filename
          let filename = document.getElementById("data").value;

          // download as base64 file
          let anchor = document.createElement("a");
          anchor.href = "data:image/png;base64," + base64Data;
          anchor.download = id + "-" + filename;
          anchor.click();
        });
      }

      function controllerUpdate(controller, reason, some) {
        if (reason === "locations") {
          let locations = controller.filters.locations;
          let artists = corpus.artistsForLocations(locations);
          let datasets = frc.artistsToDatasets(artists);
          let artistsController = lotivis.parseDatasets(datasets);
          plotChart.setController(artistsController);
        } else {
          plotChart.setController(new lotivis.DataController([]));
        }
      }

      function setDataset(index) {
        let dataset = datasets[index];
        let controller = lotivis.parseDataset(dataset);

        barChart.setController(controller);
        mapChart.setController(controller);

        controller.on("change", controllerUpdate);
      }

      function dataChange() {
        setDataset(document.getElementById("data").selectedIndex);
      }

      Promise.all([
        lotivis.d3.json("./assets/corpus.json"),
        lotivis.d3.json("./assets/departements.geojson"),
        lotivis.d3.json("./assets/corpus.overview.tracks.json"),
        lotivis.d3.json("./assets/corpus.overview.words.json"),
        lotivis.d3.json("./assets/corpus.overview.types.json"),
        lotivis.d3.json("./assets/corpus.overview.innovation.list.json"),
        lotivis.d3.json(
          "./assets/corpus.overview.innovation.list.relative.date.json"
        ),
        lotivis.d3.json(
          "./assets/corpus.overview.innovation.list.relative.location.json"
        ),
        lotivis.d3.json("./assets/corpus.overview.innovation.list.words.json"),
        lotivis.d3.json(
          "./assets/corpus.overview.innovation.list.words.relative.date.json"
        ),
        lotivis.d3.json(
          "./assets/corpus.overview.innovation.list.words.relative.location.json"
        ),
      ])
        .then((all) => {
          let rawCorpus = all.shift();
          corpus = new frc.Corpus(rawCorpus);
          barChart.config.dates = corpus.dates();

          let geoJSON = all.shift();
          mapChart.setGeoJSON(geoJSON);

          datasets = all;
          setDataset(0);

          lotivis.d3.select("#loading-indicator").style("display", "none");
        })
        .catch((e) => {
          console.error(e);
          alert(e);
        });

      function setText(id, text) {
        document.getElementById(id).innerText =
          lotivis.config.numberFormat(text);
      }

      lotivis.d3.json("./assets/about.json").then((about) => {
        setText("frcv-artists-all", about.artists.all);
        setText("frcv-artists-female", about.artists.female);
        setText("frcv-artists-male", about.artists.male);
        setText("frcv-artists-groups", about.artists.groups);
        setText("frcv-tracks", about.tracks);
        setText("frcv-words", about.words);
        setText("frcv-types", about.types);
      });
    </script>
  </body>
</html>
